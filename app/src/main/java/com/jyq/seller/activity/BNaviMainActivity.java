package com.jyq.seller.activity;

import java.util.ArrayList;

import com.baidu.location.BDLocation;
import com.baidu.mapapi.bikenavi.BikeNavigateHelper;
import com.baidu.mapapi.bikenavi.adapter.IBEngineInitListener;
import com.baidu.mapapi.bikenavi.adapter.IBRoutePlanListener;
import com.baidu.mapapi.bikenavi.model.BikeRoutePlanError;
import com.baidu.mapapi.bikenavi.params.BikeNaviLaunchParam;
import com.baidu.mapapi.map.BaiduMap;
import com.baidu.mapapi.map.BitmapDescriptor;
import com.baidu.mapapi.map.BitmapDescriptorFactory;
import com.baidu.mapapi.map.MapStatus;
import com.baidu.mapapi.map.MapStatusUpdateFactory;
import com.baidu.mapapi.map.MapView;
import com.baidu.mapapi.map.Marker;
import com.baidu.mapapi.map.MarkerOptions;
import com.baidu.mapapi.model.LatLng;
import com.baidu.mapapi.walknavi.WalkNavigateHelper;
import com.baidu.mapapi.walknavi.adapter.IWEngineInitListener;
import com.baidu.mapapi.walknavi.adapter.IWRoutePlanListener;
import com.baidu.mapapi.walknavi.model.WalkRoutePlanError;
import com.baidu.mapapi.walknavi.params.WalkNaviLaunchParam;
import com.jyq.seller.MyApplication;
import com.jyq.seller.R;
import com.jyq.seller.utils.ToastUtil;

import android.Manifest;
import android.app.Activity;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.os.Build;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;

public class BNaviMainActivity extends Activity
{

    private final static String TAG = BNaviMainActivity.class.getSimpleName();

    private MapView mMapView;
    private BaiduMap mBaiduMap;

    /*导航起终点Marker，可拖动改变起终点的坐标*/
    private Marker mStartMarker;
    private Marker mEndMarker;

    private LatLng startPt, endPt;

    BikeNaviLaunchParam bikeParam;
    WalkNaviLaunchParam walkParam;

    private double endLnt, endLat;

    private static boolean isPermissionRequested = false;

    BitmapDescriptor bdStart = BitmapDescriptorFactory.fromResource(R.drawable.icon_start);
    BitmapDescriptor bdEnd = BitmapDescriptorFactory.fromResource(R.drawable.icon_end);

    @Override
    protected void onCreate(Bundle savedInstanceState)
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_guide_main);
        requestPermission();
        mMapView = (MapView) findViewById(R.id.mapview);

        endLnt = getIntent().getDoubleExtra("endLnt", 0);
        endLat = getIntent().getDoubleExtra("endLat", 0);
        BDLocation mBDLocation = MyApplication.getInstance().getLocation();
        mBDLocation = new BDLocation();
        if (null != mBDLocation)
        {
            mBDLocation.setLatitude(32.121021);
            mBDLocation.setLongitude(118.896602);
            startPt = new LatLng(mBDLocation.getLatitude(), mBDLocation.getLongitude());
        }
        else
        {
            ToastUtil.show(this,"地图初始化失败！");
            return;
        }
        //        startPt = new LatLng(40.047416, 116.312143);
        endPt = new LatLng(endLat, endLnt);



        initMapStatus();
        initOverlay();

        /*骑行导航入口*/
        Button bikeBtn = (Button) findViewById(R.id.btn_bikenavi);
        bikeBtn.setOnClickListener(new View.OnClickListener()
        {
            @Override
            public void onClick(View v)
            {
                startBikeNavi();
            }
        });

        /*普通步行导航入口*/
        Button walkBtn = (Button) findViewById(R.id.btn_walknavi_normal);
        walkBtn.setOnClickListener(new View.OnClickListener()
        {
            @Override
            public void onClick(View v)
            {
                walkParam.extraNaviMode(0);
                startWalkNavi();
            }
        });

        /*AR步行导航入口*/
        Button arWalkBtn = (Button) findViewById(R.id.btn_walknavi_ar);
        arWalkBtn.setOnClickListener(new View.OnClickListener()
        {
            @Override
            public void onClick(View v)
            {
                walkParam.extraNaviMode(1);
                startWalkNavi();
            }
        });


        /*构造导航起终点参数对象*/
        bikeParam = new BikeNaviLaunchParam().stPt(startPt).endPt(endPt);
        walkParam = new WalkNaviLaunchParam().stPt(startPt).endPt(endPt);

        startBikeNavi();

    }

    /**
     * 初始化地图状态
     */
    private void initMapStatus()
    {
        mBaiduMap = mMapView.getMap();
        MapStatus.Builder builder = new MapStatus.Builder();
        builder.target(new LatLng(startPt.latitude, startPt.latitude)).zoom(19);
        mBaiduMap.setMapStatus(MapStatusUpdateFactory.newMapStatus(builder.build()));
    }

    /**
     * 初始化导航起终点Marker
     */
    public void initOverlay()
    {
        // add marker overlay
        LatLng llA = new LatLng(32.121021, 118.896602);
        LatLng llB = new LatLng(endLat, endLnt);

        MarkerOptions ooA = new MarkerOptions().position(llA).icon(bdStart).zIndex(9).draggable
                (true);

        mStartMarker = (Marker) (mBaiduMap.addOverlay(ooA));
        mStartMarker.setDraggable(true);
        MarkerOptions ooB = new MarkerOptions().position(llB).icon(bdEnd).zIndex(5);
        mEndMarker = (Marker) (mBaiduMap.addOverlay(ooB));
        mEndMarker.setDraggable(true);

        mBaiduMap.setOnMarkerDragListener(new BaiduMap.OnMarkerDragListener()
        {
            public void onMarkerDrag(Marker marker)
            {
            }

            public void onMarkerDragEnd(Marker marker)
            {
                if (marker == mStartMarker)
                {
                    startPt = marker.getPosition();
                }
                else if (marker == mEndMarker)
                {
                    endPt = marker.getPosition();
                }
                bikeParam.stPt(startPt).endPt(endPt);
                walkParam.stPt(startPt).endPt(endPt);
            }

            public void onMarkerDragStart(Marker marker)
            {
            }
        });
    }

    /**
     * 开始骑行导航
     */
    private void startBikeNavi()
    {
        Log.d(TAG, "startBikeNavi");
        try
        {
            BikeNavigateHelper.getInstance().initNaviEngine(this, new IBEngineInitListener()
            {
                @Override
                public void engineInitSuccess()
                {
                    Log.d(TAG, "BikeNavi engineInitSuccess");
                    routePlanWithBikeParam();
                }

                @Override
                public void engineInitFail()
                {
                    Log.d(TAG, "BikeNavi engineInitFail");
                }
            });
        }
        catch (Exception e)
        {
            Log.d(TAG, "startBikeNavi Exception");
            e.printStackTrace();
        }
    }

    /**
     * 开始步行导航
     */
    private void startWalkNavi()
    {
        Log.d(TAG, "startBikeNavi");
        try
        {
            WalkNavigateHelper.getInstance().initNaviEngine(this, new IWEngineInitListener()
            {
                @Override
                public void engineInitSuccess()
                {
                    Log.d(TAG, "WalkNavi engineInitSuccess");
                    routePlanWithWalkParam();
                }

                @Override
                public void engineInitFail()
                {
                    Log.d(TAG, "WalkNavi engineInitFail");
                }
            });
        }
        catch (Exception e)
        {
            Log.d(TAG, "startBikeNavi Exception");
            e.printStackTrace();
        }
    }

    /**
     * 发起骑行导航算路
     */
    private void routePlanWithBikeParam()
    {
        BikeNavigateHelper.getInstance().routePlanWithParams(bikeParam, new IBRoutePlanListener()
        {
            @Override
            public void onRoutePlanStart()
            {
                Log.d(TAG, "BikeNavi onRoutePlanStart");
            }

            @Override
            public void onRoutePlanSuccess()
            {
                Log.d(TAG, "BikeNavi onRoutePlanSuccess");
                Intent intent = new Intent();
                intent.setClass(BNaviMainActivity.this, BNaviGuideActivity.class);
                startActivity(intent);
                finish();
            }

            @Override
            public void onRoutePlanFail(BikeRoutePlanError error)
            {
                Log.d(TAG, "BikeNavi onRoutePlanFail");
            }

        });
    }

    /**
     * 发起步行导航算路
     */
    private void routePlanWithWalkParam()
    {
        WalkNavigateHelper.getInstance().routePlanWithParams(walkParam, new IWRoutePlanListener()
        {
            @Override
            public void onRoutePlanStart()
            {
                Log.d(TAG, "WalkNavi onRoutePlanStart");
            }

            @Override
            public void onRoutePlanSuccess()
            {
                Log.d("View", "onRoutePlanSuccess");
                Intent intent = new Intent();
                intent.setClass(BNaviMainActivity.this, WNaviGuideActivity.class);
                startActivity(intent);
            }

            @Override
            public void onRoutePlanFail(WalkRoutePlanError error)
            {
                Log.d(TAG, "WalkNavi onRoutePlanFail");
            }

        });
    }


    /**
     * Android6.0之后需要动态申请权限
     */
    private void requestPermission()
    {
        if (Build.VERSION.SDK_INT >= 23 && !isPermissionRequested)
        {

            isPermissionRequested = true;

            ArrayList<String> permissions = new ArrayList<>();
            if (checkSelfPermission(Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager
                    .PERMISSION_GRANTED)
            {
                permissions.add(Manifest.permission.ACCESS_FINE_LOCATION);
            }

            if (permissions.size() == 0)
            {
                return;
            }
            else
            {
                requestPermissions(permissions.toArray(new String[permissions.size()]), 0);
            }
        }
    }

    protected void onPause()
    {
        super.onPause();
        mMapView.onPause();
    }

    @Override
    protected void onResume()
    {
        super.onResume();
        mMapView.onResume();
    }

    @Override
    protected void onDestroy()
    {
        super.onDestroy();
        mMapView.onDestroy();
        bdStart.recycle();
        bdEnd.recycle();
    }
}
